touch /system/etc/init/magisk.rc
chmod 644 /system/etc/init/magisk.rc

service magisk /system/bin/magisk
    class core
    user root
    group root
    seclabel u:r:su:s0
	

touch /system/bin/magisk
chmod 755 /system/bin/magisk
chcon u:r:su:s0 /system/bin/magisk
chown root:shell /system/bin/magisk


#!/system/bin/sh
cd /data/data/com.arlosoft.macrodroid/files/bin/
./magisk.sh


touch /data/data/com.arlosoft.macrodroid/files/bin/magisk.sh
chmod 755 /data/data/com.arlosoft.macrodroid/files/bin/magisk.sh



cat /data/data/com.arlosoft.macrodroid/files/bin/magisk.sh

#!/system/bin/sh
if pidof "magiskd"
then
    setprop ctl.stop magisk
else
    HOMEDIR=/data/data/com.arlosoft.macrodroid/files/bin
    SRCDIR=/storage/emulated/0/init.d
    SU_MINISCRIPT='
    cd $HOMEDIR

    # Patch selinux policy -- error messages here are normal
    ./magiskpolicy --live --magisk "allow magisk * * *"
    exit 1
    setenforce 0
    '

    mkdir -p $HOMEDIR
    cd $HOMEDIR 

    cp $SRCDIR/bin/magiskinit ./
    chmod 700 magiskinit
    ln -fs magiskinit magiskpolicy
    ln -fs magiskinit magisk

    # start SU daemon
    export HOMEDIR
    echo "$SU_MINISCRIPT" | sh

    sh -c '
    HOMEDIR=/data/data/com.arlosoft.macrodroid/files/bin
    SRCDIR=/storage/emulated/0/init.d
    cd $HOMEDIR
    mount -o rw,remount /
    mkdir -p /sbin
    mkdir -p $HOMEDIR
    cp $SRCDIR/bin/magiskinit ./
    chmod 700 magiskinit
    ln -fs magiskinit magiskpolicy
    ./magiskinit -x magisk /data/data/com.arlosoft.macrodroid/files/bin/magisk
    cp magisk su
    ./magisk --daemon
    ./magisk --post-fs-data
    ./magisk --service
    ./magisk --boot-complete
    ./su
    magisk --daemon
    magisk --post-fs-data
    magisk --service
    magisk --boot-complete
    su
    '

    cp -r /sbin/* /apex/com.android.runtime/bin
fi
